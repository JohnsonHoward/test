<?xml version="1.0" encoding="UTF-8" ?>
<Module>
    <ModulePrefs
            title="Test"
            author="JH"
            thumbnail="https://www.redmineup.com/cms/assets/thumbnail/33796/600/jira_logo.png"
            screenshot="https://www.redmineup.com/cms/assets/thumbnail/33796/600/jira_logo.png"
            description="JIRA Server Dashboard Description">

        <Require feature="minimessage" />
        <Require feature="dynamic-height" />
        <Require feature="auth-refresh"/>
        <Require feature="oauthpopup" />
        <Require feature="setprefs" />
        <Require feature="settitle" />
        <Require feature="core" />
        <Require feature="core.io" />
        <Require feature="views" />
        <Optional feature="atlassian.util" />
        <Optional feature="gadget-directory">
            <Param name="categories">Other</Param>
        </Optional>
    </ModulePrefs>

    <UserPref name="columnNames" datatype="hidden" default_value="--Default--"/>
    <UserPref name="sortColumn" datatype="hidden" default_value=""/>
    <UserPref name="refresh" datatype="hidden" default_value="false"/>
    <Content type="html">
        <![CDATA[
<script type="text/javascript" src="https://code.jquery.com/jquery-1.7.2.min.js">
var contextPath = "https://avst-prod511.adaptavist.cloud";
gadgets.window.setTitle("__MSG_gadget.assignedtome.title__");
var gadget = AJS.Gadget({
  baseUrl: "https://avst-prod511.adaptavist.cloud",
  useOauth: "/rest/gadget/1.0/currentUser",
  config: {
    descriptor: function(args) {
      var gadget = this;
      return {
        action: "/rest/gadget/1.0/issueTable/jql/validate",
        theme: function() {
          if (gadgets.window.getViewportDimensions().width < 450) {
            return "gdt top-label";
          } else {
            return "gdt";
          }
        }(),
        fields: [AJS.gadget.fields.numberToShow(gadget, "num"), columnGadgetFieldType(gadget, "columnNames", args.columnChoices.availableColumns), AJS.gadget.fields.nowConfigured()]
      };
    },
    args: [{
      key: "columnChoices",
      ajaxOptions: "/rest/gadget/1.0/availableColumns"
    }]
  },
  view: {
    onResizeAdjustHeight: true,
    enableReload: true,
    template: function(args) {
      var gadget = this;
      args.linkHtml = "<a href=\"https://avst-prod511.adaptavist.cloud/issues/?jql=assignee+in+%28currentUser%28%29%29+AND+resolution+%3D+unresolved+ORDER+BY+priority+DESC%2C+created+ASC\" target=\"_parent\" title=\"__MSG_gadget.assignedtome.title__\">";
      args.linkEndHtml = "</a>";
      args.issueTable.empty = args.issueTable.displayed === 0;
      args.issueTable.hasPaging = args.issueTable.displayed === args.issueTable.total;
      gadget.getView().attr("id", "assigned-to-me-content").html(JIRA.Templates.Gadgets.assignedToMe(args));
      var $resultCountLink = gadget.getView().find(".results-count-link");
      $resultCountLink.replaceWith(AJS.$(args.linkHtml + $resultCountLink.html() + args.linkEndHtml));
      AJS.$("th.sortable").each(function() {
        this.onclick = null;
      }).click(function() {
        gadget.savePref("sortColumn", AJS.$(this).attr("rel"));
        gadget.sortBy = AJS.$(this).attr("rel");
        gadget.showView(true);
      });
      AJS.$(".pagination a").click(function(event) {
        event.preventDefault();
        gadget.startIndex = AJS.$(this).attr("rel");
        gadget.showView(true);
      });
      if (gadget.isLocal()) {
        if (typeof contextPath === "undefined") {
          contextPath = "https://avst-prod511.adaptavist.cloud";
        }
        AJS.Dropdown.create({
          trigger: ".issue-actions-trigger",
          autoScroll: false,
          ajaxOptions: {
            dataType: "json",
            cache: false,
            formatSuccess: JIRA.FRAGMENTS.issueActionsFragment
          }
        });
      }
      jQuery("#issuetable tr").hover(function() {
        jQuery(this).addClass("hover");
      }, function() {
        if (!AJS.dropDown.current) {
          jQuery(this).removeClass("hover");
        }
      });
    },
    args: [{
      key: "issueTable",
      ajaxOptions: function() {
        var gadget = this;
        var columnNames = gadget.getPrefArray("columnNames");
        var hasDefault = false;
        var indexOf = -1;
        for (var i = 0; i < columnNames.length; i++) {
          if (columnNames[i] === "--Default--") {
            hasDefault = true;
            indexOf = i;
            break;
          }
        }
        if (hasDefault) {
          columnNames.splice(indexOf, 1);
        }
        if (!this.sortBy) {
          this.sortBy = gadget.getPref("sortColumn") || null;
        }
        return {
          url: "/rest/gadget/1.0/issueTable/jql",
          data: {
            jql: "assignee = currentUser() AND resolution = unresolved ORDER BY priority DESC, created ASC",
            num: this.getPref("num"),
            addDefault: hasDefault,
            columnNames: columnNames,
            enableSorting: true,
            sortBy: function() {
              if (gadget.sortBy && gadget.sortBy !== "") {
                return gadget.sortBy;
              } else {
                return null;
              }
            }(),
            paging: true,
            startIndex: function() {
              if (gadget.startIndex && gadget.startIndex !== "") {
                return gadget.startIndex;
              } else {
                return "0";
              }
            }(),
            showActions: gadget.isLocal()
          }
        };
      }
    }]
  }
});

</script>
<script>
function refresh() {
jQuery.ajax({
 type: "GET",
 dataType: "json",
                   "contentType": "application/json",
                   url: "https://avst-prod511.adaptavist.cloud/rest/scriptrunner/latest/custom/gadgetEndpoint",
                   data: "d"
                 }).done(function(data) {
                    $("#eth").append(JSON.stringify(data))
                 }).fail(function() {
                    $("#eth").append("Something Went Wrong")
});
}

refresh();
</script>
]]>
    </Content>
</Module>